{% from 'fields.html' import field, field_map %}

{% extends 'base.html' %}

{% block page_title %}Create a new journey{% endblock %}

{% block body_id %}page-journeys-add{% endblock %}

{% block css %}
    {{ super() }}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/journeys_add.css') }}"/>
{% endblock %}

{% block js %}
    {{ super() }}
    <script>
        var defaultCoords = {lat: 51.5, lng: 0};
        {% macro coords(lat, lng) -%}
            {{ "{lat: %s, lng: %s}"|format(lat, lng) if lat != None and lng != None else "null" }}
        {%- endmacro %}
        var startCoords = {{ coords(form.start_lat.data, form.start_lng.data) }};
        var finishCoords = {{ coords(form.finish_lat.data, form.finish_lng.data) }};
    </script>
    <script src="{{ url_for('static', filename='js/journeys_add.js') }}"></script>
    {% with %}
        {% set base_url = "https://maps.googleapis.com/maps/api/js" %}
        {% set key = config.GOOGLE_MAPS_API_KEY %}
        {% set libraries = "geometry" %}
        {% set callback = "initMap" %}
        <script async defer
                src="{{ base_url }}?key={{ key }}&libraries={{ libraries }}&callback={{ callback }}"></script>
    {% endwith %}
{% endblock %}

{% block breadcrumbs %}
    <li><a href="{{ url_for('journeys') }}">Journeys</a></li>
{% endblock %}

{% block page_content %}
    <form method="post">
        {{ form.hidden_tag() }}

        {% if form.errors %}
            <div class="alert alert-danger" role="alert">
                <strong>Journey not created.</strong> Please fix any errors below and try again.
            </div>
        {% endif %}

        {{ field(form.name, "Name: ") }}

        {{ form.distance_meters(id="distance-meters", type="hidden") }}

        {{ field_map(form.start_lat, form.start_lng, "Start:", "map-start", "startLat", "startLng") }}

        {{ field_map(form.finish_lat, form.finish_lng, "Finish:", "map-finish", "finishLat", "finishLng") }}

        <input type="submit" class="btn btn-primary btn-lg" value="Submit"/>
    </form>
{% endblock %}