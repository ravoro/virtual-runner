{% extends "base.html" %}

{% set content_without_container = True %}

{% block page_title %}{{ journey.name }}{% endblock %}

{% block body_id %}page-journey{% endblock %}

{% block css %}
    {{ super() }}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/journey.css') | asset_release_version }}"/>
{% endblock %}

{% block js %}
    {{ super() }}
    <script>
        var startCoords = {lat: {{ journey.start_lat }}, lng: {{ journey.start_lng }}};
        var finishCoords = {lat: {{ journey.finish_lat }}, lng: {{ journey.finish_lng }}};
        var stagesDistance = {{ journey.completed_distance }};
        var totalDistance = {{ journey.distance_meters }};
        var fractionCompleted = {{ journey.completed_fraction }};
    </script>
    <script src="{{ url_for('static', filename='js/journey.js') | asset_release_version }}"></script>
    {% with %}
        {% set base_url = "https://maps.googleapis.com/maps/api/js" %}
        {% set key = config.GOOGLE_MAPS_API_KEY %}
        {% set libraries = "geometry" %}
        {% set callback = "initMap" %}
        <script async defer
                src="{{ base_url }}?key={{ key }}&libraries={{ libraries }}&callback={{ callback }}"></script>
    {% endwith %}
{% endblock %}

{% block breadcrumbs %}
    <li><a href="{{ url_for('controllers.journeys') }}">Journeys</a></li>
{% endblock %}

{% block page_actions %}
    <button class="btn btn-primary" type="button" data-toggle="modal" data-target="#journey-details-modal">
        <span class="glyphicon glyphicon-th-list" aria-hidden="true"></span>
        <span>View details</span>
    </button>
    <a class="btn btn-primary" href="{{ url_for('controllers.journeys_add_stage', jid=journey.id) }}">
        <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
        <span>Record a new run</span>
    </a>
{% endblock %}

{% block page_content %}
    <div id="journey-details-modal" class="modal fade" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title">Journey Details</h4>
                </div>
                <div class="modal-body">
                    <dl>
                        <div id="journey-distance-details">
                            <dt>Completion:</dt>
                            <dd>{{ journey.completed_fraction|fraction_to_percentage }} %</dd>

                            <dt>Distance:</dt>
                            <dd>
                                {{ journey.completed_distance|meters_to_km }} /
                                {{ journey.distance_meters|meters_to_km }} km
                                <em>
                                    ({{ (journey.distance_meters - journey.completed_distance)|meters_to_km }}
                                    km remaining)
                                </em>
                            </dd>

                            {% if journey.completed_distance > journey.distance_meters %}
                                <dt><em>Note:</em></dt>
                                <dd>
                                    <em>
                                        You've run an additional
                                        {{ (journey.completed_distance - journey.distance_meters)|meters_to_km }}km
                                    </em>
                                </dd>
                            {% endif %}
                        </div>

                        <dt>Runs:</dt>
                        <dd>
                            {% if stages %}
                                <table class="table table-striped table-condensed">
                                    <tbody>
                                    {% for stage in stages %}
                                        <tr>
                                            <td>{{ stage.date_created|format_date|default('----', true) }}</td>
                                            <td>{{ stage.distance_meters|meters_to_km }} km</td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            {% else %}
                                <p><em>You have not added any runs.</em></p>
                            {% endif %}
                        </dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>

    <div id="map"></div>
{% endblock %}
